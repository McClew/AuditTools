## Check for ESET Endpoint Security
$esetProducts = Get-CimInstance -Namespace root/SecurityCenter2 -ClassName AntivirusProduct | Where-Object { $_.displayName -like "*ESET*" }
$esetEnabled = $false

if ($esetProducts) {
    # ProductState is a bitmask. 266240 usually means "Enabled and Up to date"
    # A more robust check is to convert the state to Hex
    $HexState = "0x{0:x}" -f $esetProducts.productState
    # Hex second byte '1' usually indicates enabled
    $esetEnabled = if ($HexState -like "*1?00") { $true } else { $false }
}

if ($esetEnabled) {
    Action1-Set-CustomAttribute "Anti-Malware" "Pass: ESET Active"
} else {
    # Check Windows Defender status
    $antivirusOutput = Get-MpComputerStatus

    $updated = if ($antivirusOutput.AntispywareSignatureAge -lt 2) { "True" } else { "False" }

    $defenderEnabledCheckResult = if ($antivirusOutput.AMServiceEnabled) { "Pass" } else { "Fail" }
    $defenderUpdatedCheckResult = if ($updated -eq "True") { "Pass" } else { "Fail" }

    # Check Windows Defender status
    $antivirusOutput = Get-MpComputerStatus

    $updated = if ($antivirusOutput.AntispywareSignatureAge -lt 2) { "True" } else { "False" }

    $defenderEnabledCheckResult = if ($antivirusOutput.AMServiceEnabled) { "Pass" } else { "Fail" }
    $defenderUpdatedCheckResult = if ($updated -eq "True") { "Pass" } else { "Fail" }

    $finalResult = if($defenderEnabledCheckResult -eq "Pass" -and $defenderUpdatedCheckResult -eq "Pass") { "Pass" } else { "Fail" }

    # Apply findings to Action1 UDF
    Action1-Set-CustomAttribute "Anti-Malware" "$finalResult";
}

